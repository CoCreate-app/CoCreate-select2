/* CoCreateJS */
var selectsData=[],getOptionSelectData=[];function initSocketsForSelect2(){CoCreateSocket.listen("connect",function(e){console.log("socket connected"),socketConnectedForSelect2()}),CoCreateSocket.listen("getDocumentList",function(e){fetchedSelectableIdsFromCollection(e)}),CoCreateSocket.listen("updateDocument",function(e){fetchedDataForSelect2(e)}),CoCreateSocket.listen("getDocument",function(e){fetchedOptionsForSelect2(e),fetchedSelectableIdsFromArray(e),fetchedDataForSelect2(e)}),CoCreateSocket.listen("createDocument",function(e){})}function socketConnectedForSelect2(){initAllSelect2()}function initAllSelect2(){initOptionSelect2(),selectsData=[];for(var e=document.getElementsByTagName("form"),t=0;t<e.length;t++){var a=e[t];initSelect2s(a),initGetOptionSelects(a)}}function initOptionSelect2(){$("select."+optionSelect2Class).select2()}function initGetOptionSelects(e){var t=e.querySelectorAll("."+getOptionSelect2Class),a=e.getAttribute("data-collection");a=a||"module_activity";var i=e.getAttribute("data-realtime");i="false"!=i;for(var l=0;l<t.length;l++){var c=t[l],o=$(c).attr("data-collection_fetch"),n=$(c).attr("data-fetch_name"),d=$(c).attr("data-fetch_module_activity_id"),r=$(c).attr("data-fetch_document_id"),u=$(c).attr("data-document_id"),f=$(c).attr("data-module_activity_id"),m=$(c).attr("name"),s=e.getAttribute("data-form_id"),_={fetchCollection:o||"module_activity",data_fetch_name:n,data_fetch_module_activity_id:d,data_fetch_module_id:r,collection:a,data_module_id:u,data_module_activity_id:f,name:m,element:c,data:[],gotOptions:!1,form_id:s};getOptionSelectData.push(_),initGetOptionSelect(e,_),fetchOptionsForSelect(_)}}function initGetOptionSelect(e,t){var a=t.element,i=t.data,l=e.getAttribute("data-realtime");$(a).select2({data:i}),$(a).on("select2:select select2:unselect",function(e){var i=t.collection,c=t.data_module_id,o=t.data_module_activity_id,n=t.name;if("false"!=l){$(a).select2("data");var d=getSelect2Value(a),r="module_activity"==i?o:c,u={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":i,id:r,data:{[n]:d}};console.log("emit",u),CoCreateSocket.send("updateDocument",u)}})}function initSelect2s(e){var t=e.querySelectorAll("."+select2Class),a=e.getAttribute("data-collection");a=a||"module_activity";var i=e.getAttribute("data-realtime");i="false"!=i;for(var l=0;l<t.length;l++){var c,o=t[l],n=$(o).attr("data-module_fetch"),d=($(o).attr("data-template_id"),$(o).attr("data-selected_template_id"),$(o).attr("data-collection_fetch")),r=$(o).attr("data-document_id"),u=$(o).attr("data-module_activity_id"),f=$(o).attr("data-fetch_name"),m=$(o).attr("data-fetch_module_activity_id"),s=$(o).attr("data-fetch_document_id"),_=$(o).attr("data-template_collection");c=f?"array":"collection";var g=$(o).attr("name"),v=e.getAttribute("data-form_id");n=n?n.replace(/\s/g,"").split(","):[];var y={collection:a,data_module_id:r,data_module_activity_id:u,fetchCollection:d||"module_activity",module_fetch:n,data_fetch_name:f,data_fetch_module_activity_id:m,data_fetch_module_id:s,data_template_collection:_||"module_activity",select_type:c,name:g,element:o,data:[],gotSelectableIds:!1,form_id:v};selectsData.push(y),initSelect2(e,y),fetchSelectableIds(y)}}function initSelect2(e,t){var a=t.element,i=t.data,l=e.getAttribute("data-realtime");$(a).select2({data:i,templateResult:getTemplate,templateSelection:templateSelection,matcher:matcher}),$(a).on("select2:select select2:unselect",function(e){var i=t.collection,c=t.data_module_id,o=t.data_module_activity_id,n=t.name;if("false"!=l){$(a).select2("data");var d=getSelect2Value(a),r="module_activity"==i?o:c,u={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":i,id:r,data:{[n]:d}};console.log("emit",u),CoCreateSocket.send("updateDocument",u)}})}function fetchOptionsForSelect(e){var t="module_activity"==e.fetchCollection?e.data_fetch_module_activity_id:e.data_fetch_module_id,a={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":e.fetchCollection,id:t};CoCreateSocket.send("getDocument",a)}function fetchSelectableIds(e){if(console.log(e),"collection"==e.select_type){var t={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":e.fetchCollection};CoCreateSocket.send("getDocumentList",t)}else if("array"==e.select_type){var a="module_activity"==e.fetchCollection?e.data_fetch_module_activity_id:e.data_fetch_module_id;t={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":e.fetchCollection,id:a};CoCreateSocket.send("getDocument",t)}}function fetchedOptionsForSelect2(e){for(var t=0;t<getOptionSelectData.length;t++){var a=getOptionSelectData[t],i=a.element;if(!a.gotOptions){var l="module_activity"==a.fetchCollection?a.data_fetch_module_activity_id:a.data_fetch_module_id;if(a.fetchCollection==e["data-collection"]&&l==e.id){var c=a.data_fetch_name;if(c in e.result){var o=e.result[c];console.log(o),a.data=o,$(i).select2({data:a.data}),a.gotOptions=!0;var n="module_activity"==a.collection?a.data_module_activity_id:a.data_module_id;if(n){var d={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":a.collection,id:n};CoCreateSocket.send("getDocument",d)}}}}}}function fetchedSelectableIdsFromCollection(e){for(var t=0;t<selectsData.length;t++){var a=selectsData[t],i=a.element;if(!a.gotSelectableIds&&"collection"==a.select_type&&a.fetchCollection==e["data-collection"]){var l=[];if("module_activity"==e["data-collection"]){var c=a.module_fetch;l=e.result.filter(function(e){return 0==c.length||c.indexOf(e["data-document_id"])>-1})}else l=e.result;for(var o=i.getAttribute("data-template_id"),n=i.getAttribute("data-selected_template_id"),d=getTemplateFields(o,n),r=(e=[],0);r<l.length;r++)e.push({collection:a.fetchCollection,id:l[r]._id,fields:Object.assign({},d),templateId:o,selectedTemplateId:n});a.data=e,$(i).select2({data:a.data,templateResult:getTemplate,templateSelection:templateSelection,matcher:matcher}),a.gotSelectableIds=!0,fetchSelectData(a)}}}function fetchedSelectableIdsFromArray(e){for(var t=0;t<selectsData.length;t++){var a=selectsData[t],i=a.element;if(!a.gotSelectableIds&&"array"==a.select_type){var l="module_activity"==a.fetchCollection?a.data_fetch_module_activity_id:a.data_fetch_module_id;if(a.fetchCollection==e["data-collection"]&&l==e.id){var c=a.data_fetch_name;if(c in e.result){var o=e.result[c],n=i.getAttribute("data-template_id"),d=i.getAttribute("data-selected_template_id"),r=getTemplateFields(n,d);console.log(o);e=[];for(var u=0;u<o.length;u++)e.push({collection:a.data_template_collection,id:o[u],fields:Object.assign({},r),templateId:n,selectedTemplateId:d});a.data=e,$(i).select2({data:a.data,templateResult:getTemplate,templateSelection:templateSelection,matcher:matcher}),a.gotSelectableIds=!0,fetchSelectData(a)}}}}}function fetchSelectData(e){for(var t=e.data,a=0;a<t.length;a++){var i=t[a],l=i.collection,c={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":l,id:i.id};CoCreateSocket.send("getDocument",c)}var o="module_activity"==e.collection?e.data_module_activity_id:e.data_module_id;if(o){c={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":e.collection,id:o};CoCreateSocket.send("getDocument",c)}}function fetchedDataForSelect2(e){for(var t=e["data-collection"],a=document.getElementsByTagName("form"),i=0;i<a.length;i++)for(var l=a[i],c=l.querySelectorAll("select."+optionSelect2Class),o=l.getAttribute("data-collection")?l.getAttribute("data-collection"):"module_activity",n=0;n<c.length;n++){var d=c[n],r=d.getAttribute("data-document_id"),u=d.getAttribute("data-module_activity_id"),f=d.getAttribute("data-fetch_value"),m=d.getAttribute("name");if("false"!=f)if("module_activity"==o&&"module_activity"==t){if(u==e.id)for(var s in e.result)if(s==m&&e.result[s]){var _=e.result[s];$(d).val(_).trigger("change")}}else if(o==t&&r==e.id)for(var s in e.result)if(s==m&&e.result[s]){_=e.result[s];$(d).val(_).trigger("change")}updateFloatLabel(d,getSelect2Value(d))}updateSelectData(e,t),updatGetOptionSelect(e,t)}function updateSelectData(e,t){for(var a=0;a<selectsData.length;a++){for(var i=selectsData[a],l=0;l<i.data.length;l++){var c=i.data[l];if(c.id==e.id&&c.collection==t)for(var o in c.fields)for(var n in e.result)if(o==n){i.data[l].fields[o]=e.result[n];var d=selectsData[a].element,r=selectsData[a].data;$(d).select2({data:r,templateResult:getTemplate,templateSelection:templateSelection,matcher:matcher})}}if(i.collection==t){if(i.data_module_activity_id==e.id&&"module_activity"==t)for(var o in e.result)if(i.name==o){var u=e.result[o];console.log("value change"),$(i.element).val(u).trigger("change"),updateFloatLabel(i.element,getSelect2Value(i.element))}if(i.data_module_id==e.id&&"module_activity"!=t)for(var o in e.result)if(i.name==o){u=e.result[o];$(i.element).val(u).trigger("change"),updateFloatLabel(i.element,getSelect2Value(i.element))}}}}function updatGetOptionSelect(e,t){for(var a=0;a<getOptionSelectData.length;a++){var i=getOptionSelectData[a];if(i.collection==t){if(i.data_module_activity_id==e.id&&"module_activity"==t)for(var l in e.result)if(i.name==l){var c=e.result[l];console.log("value change"),$(i.element).val(c).trigger("change"),updateFloatLabel(i.element,getSelect2Value(i.element))}if(i.data_module_id==e.id&&"module_activity"!=t)for(var l in e.result)if(i.name==l){c=e.result[l];$(i.element).val(c).trigger("change"),updateFloatLabel(i.element,getSelect2Value(i.element))}}}}function matcher(e,t){if(""===$.trim(e.term))return t;for(var a in t.fields){if(t.fields[a].toUpperCase().indexOf(e.term.toUpperCase())>-1)return t}return null}function getTemplate(e){if(e.id){var t=document.getElementById(e.templateId);return t.querySelectorAll("*").forEach(function(t){var a=t.getAttribute("name");(e.fields[a]||""==e.fields[a])&&(t.innerHTML=e.fields[a])}),$(t.innerHTML)}}function templateSelection(e){if(e.id){var t=document.getElementById(e.selectedTemplateId);return t.querySelectorAll("*").forEach(function(t){var a=t.getAttribute("name");(e.fields[a]||""==e.fields[a])&&(t.innerHTML=e.fields[a])}),$(t.innerHTML)}}function getTemplateFields(e,t){var a=document.getElementById(e),i=document.getElementById(t),l={};return a.querySelectorAll("*").forEach(function(e){var t=e.getAttribute("name");l[t]=""}),i.querySelectorAll("*").forEach(function(e){var t=e.getAttribute("name");l[t]=""}),l}function getSelect2Value(e){var t=$(e).select2("data");if(e.hasAttribute("multiple")){var a=[];return t.forEach(function(e){e.selected&&a.push(e.id)}),a}return t[0].id}function insertCreatedIdToSelect2(e){var t=e.form_id,a=document.querySelector("form[data-form_id='"+t+"']");if(a){var i=e.ids,l=a.getAttribute("data-collection");if("module_activity"==(l=l||"module_activity"))for(var c=0;c<selectsData.length;c++){if(t==(r=selectsData[c]).form_id&&!r.data_module_activity_id)for(var o=r.data_module_id,n=0;n<i.length;n++){var d=i[n];o==d["data-document_id"]&&(r.data_module_activity_id=d.id,r.element.setAttribute("data-module_activity_id",d.id))}}else for(c=0;c<selectsData.length;c++){var r;t!=(r=selectsData[c]).form_id||r.data_module_id||(r.data_module_id=i,r.element.setAttribute("data-document_id",i))}}}initSocketsForSelect2();